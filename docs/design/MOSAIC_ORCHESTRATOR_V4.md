# üìò `docs/design/MOSAIC_ORCHESTRATOR_V4.md`

> **Sirios Mosaic ‚Äì Orquestrador NL‚ÜíSQL (v4)**
> *Design funcional, contratos e sincroniza√ß√£o de cat√°logo*

---

## üåå 1. Vis√£o Geral

O **orquestrador** √© o n√∫cleo sem√¢ntico do Mosaic: interpreta perguntas em linguagem natural, identifica inten√ß√µes e entidades (views), monta consultas SQL seguras e devolve respostas contextualizadas.

Vers√£o **v4** introduz:

* fan-out de inten√ß√µes (ex.: dividendos + not√≠cias);
* m√∫ltiplos tickers (`IN`);
* intervalos de datas din√¢micos (‚Äú4 meses antes‚Äù, ‚Äúm√™s anterior‚Äù);
* mensagens educativas configur√°veis;
* padroniza√ß√£o de acentua√ß√£o e tokens;
* sincroniza√ß√£o autom√°tica entre **PostgreSQL ‚Üí YAMLs**;
* envelope rico de request/response (com cliente, status, planner, meta).

---

## ‚öôÔ∏è 2. Fluxo NL‚ÜíSQL Simplificado

```
Usu√°rio ‚Üí /ask ‚Üí Gateway ‚Üí Orchestrator
    ‚Üí Extratores (tickers, datas, inten√ß√µes)
        ‚Üí Builder (gera SQL parametrizado)
            ‚Üí Executor (Postgres read-only)
                ‚Üí Serializer (to_human)
                    ‚Üí Resposta enriquecida
```

---

## üß© 3. Envelope JSON ‚Äì Contratos

### 3.1 Request

```jsonc
{
  "question": "√∫ltimos dividendos e not√≠cias do HGLG e KNRI",
  "top_k": 10,
  "date_range": {"from": "2024-01-01", "to": "2024-03-31"},
  "client": {
    "token": "opaque-or-jwt",
    "client_id": "cli_123",
    "nickname": "Leleo",
    "balance": 123.45
  },
  "trace": {"request_id": "external-correlation-id"}
}
```

**Notas**

* `question` obrigat√≥rio.
* `date_range` opcional; se ausente, NLP infere (inclui express√µes relativas).
* `client` apenas ecoado, sem l√≥gica financeira nesta vers√£o.
* `top_k` limita por inten√ß√£o (default em settings).

---

### 3.2 Response

```jsonc
{
  "request_id": "abcd-123",
  "original_question": "√∫ltimos dividendos e not√≠cias do HGLG e KNRI",
  "client": {
    "client_id": "cli_123",
    "nickname": "Leleo",
    "balance_before": 123.45,
    "balance_after": 123.45
  },
  "status": {"reason": "ok", "message": "Tudo certo!"},
  "planner": {
    "intents": ["dividends", "news"],
    "entities": [
      {"intent": "dividends", "entity": "view_fiis_history_dividends"},
      {"intent": "news", "entity": "view_fiis_history_news"}
    ],
    "filters": {
      "tickers": ["HGLG11", "KNRI11"],
      "date_field": "payment_date",
      "date_from": "2024-01-01",
      "date_to": "2024-03-31"
    }
  },
  "results": {
    "dividends": [/* at√© top_k */],
    "news": [/* at√© top_k */]
  },
  "meta": {
    "elapsed_ms": 18,
    "rows_total": 6,
    "rows_by_intent": {"dividends": 3, "news": 3},
    "limits": {"top_k": 3}
  },
  "usage": {"tokens_prompt": 0, "tokens_completion": 0, "cost_estimated": 0.0}
}
```

**Valores poss√≠veis de `status.reason`**

| Reason             | Significado                            |
| ------------------ | -------------------------------------- |
| `ok`               | Tudo resolvido normalmente             |
| `intent_unmatched` | Nenhuma inten√ß√£o atingiu score m√≠nimo  |
| `partial_fanout`   | Apenas parte das inten√ß√µes respondidas |
| `error`            | Falha controlada (builder/DB/etc.)     |

---

## üß† 4. NLP e Regras Sem√¢nticas

### 4.1 Extra√ß√£o

* **Tickers**: aceita m√∫ltiplos; gera `ticker__in` se >1.
* **Datas**: reconhece `entre ... e ...` e express√µes relativas (‚Äú√∫ltimos 3 meses‚Äù, ‚Äúm√™s anterior‚Äù).
* **Inten√ß√µes**: tokens comparados com `ask.synonyms.*` e `ask.keywords`.
* **√öltimos / mais recentes**: definidos em YAML (`ask.latest_words`).

### 4.2 Normaliza√ß√£o

* Tudo processado em **min√∫sculo e sem acento**.
* Sa√≠das e YAMLs mant√™m acentua√ß√£o original para exibi√ß√£o.

### 4.3 Fallback Educativo

* Removido fallback para `view_fiis_info`.
* Se nenhuma inten√ß√£o aceita, retorna `intent_unmatched` com mensagem de ajuda vinda de `settings.messages.*`.

---

## üóìÔ∏è 5. Intervalos Relativos

Exemplos (base = data atual):

| Express√£o         | Intervalo derivado              |
| ----------------- | ------------------------------- |
| ‚Äú√∫ltimos 3 meses‚Äù | from = hoje ‚àí 90d, to = hoje    |
| ‚Äú4 meses antes‚Äù   | from = hoje ‚àí 120d, to = hoje   |
| ‚Äúm√™s anterior‚Äù    | in√≠cio e fim do m√™s anterior    |
| ‚Äúano atual‚Äù       | 01/01 at√© 31/12 do ano corrente |

Controlado por `settings.nlp.relative_dates = true`.

---

## üóÉÔ∏è 6. YAML por Entidade (`ask.synonyms + pesos`)

### Estrutura padr√£o

```yaml
entity: view_fiis_history_dividends
description: Snapshot de dividendos hist√≥ricos
default_date_field: payment_date

ask:
  intents: [dividends, historico]
  keywords: [dividendos, rendimentos, proventos]
  synonyms:
    dividends: [dividendos, rendimentos, proventos, pagamentos]
    latest: [√∫ltimo, √∫ltimos, mais recente]
  weights:
    keywords: 1
    synonyms: 2
  top_k: 6
  latest_words: [√∫ltimo, mais recente, √∫ltimos]
```

### Conven√ß√µes de escrita

* Evitar duplica√ß√µes (‚Äúhistorico‚Äù vs ‚Äúhist√≥rico‚Äù).
* Acentua√ß√£o normal, mas preloader cria vers√£o normalizada (`keywords_normalized`).
* `top_k` local substitui limite global.

---

## üßæ 7. Coment√°rios SQL ‚Üí YAML

### Sintaxe padr√£o

```sql
COMMENT ON MATERIALIZED VIEW view_fiis_info IS
'Descri√ß√£o da view.||
ask:intents=cadastro,perfil,info;
keywords=cadastro,dados,ficha,cnpj,site,administrador;
synonyms.cadastro=cadastro,dados;
latest_words=√∫ltimo,√∫ltimos,mais recente;';
```

### Colunas

```sql
COMMENT ON COLUMN view_fiis_info.ticker IS
'C√≥digo do fundo na B3.|C√≥digo FII';
```

### Conven√ß√µes

| Parte            | Significado                      |               |                                    |
| ---------------- | -------------------------------- | ------------- | ---------------------------------- |
| Texto antes de ` |                                  | `             | Descri√ß√£o humana                   |
| Ap√≥s `           |                                  | `             | Metadados (`chave=valor1,valor2;`) |
| Ap√≥s `           | ` em coluna                      | Alias exibido |                                    |
| Prefixo `ask:`   | Bloco sem√¢ntico copiado pro YAML |               |                                    |

---

## üîÑ 8. Sincroniza√ß√£o DB ‚Üî YAML

### Scripts dispon√≠veis

| Comando                                                 | A√ß√£o                             |
| ------------------------------------------------------- | -------------------------------- |
| `python -m tools.snapshot_views_from_db`                | Gera YAMLs fi√©is ao DB           |
| `python -m tools.diff_yaml_db`                          | Diff humano entre DB e YAML      |
| `python -m tools.diff_yaml_db --json`                   | Diff em JSON (CI/CD)             |
| `python -m tools.augment_yaml_from_db_comments --write` | Atualiza descri√ß√µes e blocos ask |
| `--entity view_fiis_info`                               | Limita a uma view                |

### Automa√ß√£o no boot

O `preloader` pode verificar hash YAML x hash DB e:

* emitir log de diverg√™ncia;
* opcionalmente atualizar YAMLs (`auto_sync_views: true`).

### Configs

```yaml
settings:
  auto_sync_views: true
  sync_views_on_startup: true
  sync_views_write: false
```

---

## üõ†Ô∏è 9. Endpoints Administrativos

| M√©todo                       | Rota                                   | Fun√ß√£o |
| ---------------------------- | -------------------------------------- | ------ |
| `POST /admin/views/reload`   | Recarrega cat√°logo em cache            |        |
| `POST /admin/views/sync`     | Sincroniza YAMLs com coment√°rios do DB |        |
| `GET /admin/views/diff`      | Retorna diff YAML‚ÜîDB em JSON           |        |
| `GET /admin/validate-schema` | Valida schema de views (j√° existe)     |        |

M√©tricas associadas:

* `mosaic_views_reloaded_total`
* `mosaic_views_sync_total`
* `mosaic_views_diff_detected_total`

---

## üìä 10. Limites por Entidade

Controla o n√∫mero de linhas retornadas por tipo de view.

### Configura√ß√£o global

```yaml
limits:
  ask_default_limit: 100
  ask_max_limit: 1000
  top_k_default: 3
  rows_by_entity:
    view_fiis_history_dividends: 6
    view_fiis_history_news: 3
    view_fiis_info: 1
```

### Prioridade de aplica√ß√£o

1. `YAML.ask.top_k`
2. `settings.limits.rows_by_entity[entity]`
3. `settings.limits.top_k_default`

---

## üß± 11. Arquivos-alvo

| Caminho                                      | Papel                                                       |
| -------------------------------------------- | ----------------------------------------------------------- |
| `app/orchestrator/service.py`                | Core NL‚ÜíSQL (intents, datas, tickers, planner)              |
| `app/registry/preloader.py`                  | Cache e sincroniza√ß√£o YAML‚ÜîDB                               |
| `app/registry/service.py`                    | Registro central de views e metadados                       |
| `app/core/settings.py`                       | Novas chaves `messages`, `limits`, `nlp`, `auto_sync_views` |
| `app/gateway/router.py`                      | Delega√ß√£o limpa para `route_question()`                     |
| `app/tools/augment_yaml_from_db_comments.py` | Parser de coment√°rios SQL                                   |
| `app/tools/diff_yaml_db.py`                  | Compara√ß√£o YAML‚ÜîDB                                          |
| `docs/design/MOSAIC_ORCHESTRATOR_V4.md`      | Este documento                                              |
| `data/views/*.yaml`                          | Cat√°logo de views (por entidade)                            |

---

## üß≠ 12. Fases de Implementa√ß√£o

| Fase  | Escopo                                                  | Status esperado |
| ----- | ------------------------------------------------------- | --------------- |
| **1** | Vocabul√°rios YAML, mensagens educativas, eco de cliente | ‚úÖ sem quebra    |
| **2** | Multi-ticker + fan-out (dividends/news) + top_k         | üîÑ novos testes |
| **3** | Sincroniza√ß√£o autom√°tica e endpoints admin              | üîú              |
| **4** | Intervalos relativos + m√©tricas de intent/fanout        | üîú              |

---

## ‚úÖ 13. Resultado Esperado

* Todas as 40 su√≠tes antigas continuam verdes.
* Novos testes cobrindo:

  * `intent_unmatched` com mensagens educativas;
  * multi-ticker;
  * fan-out de inten√ß√µes;
  * sync YAML‚ÜîDB dry-run;
  * limite por entidade (top_k).

> O **Sirios Mosaic v4** passa a ser semanticamente expans√≠vel, audit√°vel e educativo ‚Äî sem aumentar complexidade de c√≥digo nem perder determinismo.

---

üíæ **Fim do Documento ‚Äî `docs/design/MOSAIC_ORCHESTRATOR_V4.md`**
